<?php
include 'config.php';

session_start();

// Kiểm tra xem người dùng đã đăng nhập chưa
if(!isset($_SESSION['admin']) || $_SESSION['admin'] !== true) {
    // Nếu chưa đăng nhập, chuyển hướng về trang đăng nhập
    header("Location: login_admin.php");
    exit();
}

// Xử lý đăng xuất
if(isset($_POST['logout'])) {
    session_unset(); // Xóa tất cả các biến session
    session_destroy(); // Hủy session
    header("Location: login_admin.php");
    exit();
}

// Truy vấn cơ sở dữ liệu và lấy dữ liệu sản phẩm
$queryProducts = "SELECT * FROM banhngot";
$resultProducts = mysqli_query($conn, $queryProducts);

// Truy vấn cơ sở dữ liệu để lấy thông tin đơn hàng nhóm theo khách hàng, cùng với thông tin bánh
$queryOrders = "SELECT donhang.MaDonHang, donhang.NgayDatHang, donhang.NgayNhanHang, donhang.SoLuongBanh, donhang.GiaTriDonHang, donhang.MaKH, khachhang.TenKH, khachhang.DiaChiKH, khachhang.SoDienThoai, banhngot.TenBanh 
                FROM donhang 
                INNER JOIN khachhang ON donhang.MaKH = khachhang.MaKH 
                INNER JOIN banhngot ON donhang.MaBanh = banhngot.MaBanh 
                GROUP BY donhang.MaDonHang";

$resultOrders = mysqli_query($conn, $queryOrders);

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style/admin.css">
    <title>Admin - Quản lý sản phẩm</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap');
        /* CSS cho header */
        .header {
            display: flex; /* Sử dụng flexbox để căn ngang các phần tử */
            align-items: center; /* Căn dọc các phần tử vào giữa */
            justify-content: space-between; /* Căn phần tử bên trái và bên phải vào hai mép */
            padding: 20px; /* Khoảng cách ngoài cùng của header */
            background-color: #f2f2f2; /* Màu nền header */
        }

        /* CSS cho tiêu đề "CAKES OF BETTY" */
        .header h1 {
            margin: 0;
            font-size: 24px;
            text-align: center;
        }

        /* CSS cho thông tin chào mừng */
        .admin-info p {
            margin-bottom: 5px;
            padding-right: 10px;
            font-family: 'Quicksand', sans-serif;
            color: rgb(163, 67, 67);
        }

        /* CSS cho nút "Logout" */
        .logout-form {
            margin: 0;
            display: inline-block; /* Hiển thị form trên cùng một dòng */
        }

        .logout-btn {
            background-color: #f44336;
            color: white;
            padding: 8px 16px; /* Giảm padding để làm cho nút nhỏ hơn */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: Arial, sans-serif;
        }

        .logout-btn:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- Tiêu đề "CAKES OF BETTY" -->
        <a href="index.php" class="active"><h1>CAKES OF BETTY</h1></a>
        <!-- Thông tin chào mừng và nút "Logout" -->
        <div class="admin-info">
            <p>Xin chào, Admin &#x1F601;</p>
            <!-- Nút "Logout" -->
            <form method="POST" action="">
                <button type="submit" class="logout-btn" name="logout">Logout</button>
            </form>
        </div>
    </div>
    
    <!-- Form thêm mới sản phẩm -->
    <h2>Thêm mới sản phẩm</h2>
    <form action="add_sp.php" method="POST" enctype="multipart/form-data">
            <!-- Thêm trường MaBanh -->
        <label for="maBanh">Mã bánh:</label><br>
        <input type="text" id="maBanh" name="maBanh"><br>
        <label for="tenBanh">Tên bánh:</label><br>
        <input type="text" id="tenBanh" name="tenBanh"><br>
        <label for="description">Mô tả:</label><br>
        <textarea id="description" name="description"></textarea><br>
        <label for="price">Giá:</label><br>
        <input type="text" id="price" name="price"><br>
        <!-- Thêm trường MaNSX -->
        <label for="maNSX">Mã nhà sản xuất:</label><br>
        <input type="text" id="maNSX" name="maNSX"><br>
        <!-- Thêm trường MaLoai -->
        <label for="maLoai">Mã loại bánh:</label><br>
        <input type="text" id="maLoai" name="maLoai"><br>
        <label for="image">Hình ảnh:</label><br>
        <input type="file" id="image" name="image"><br><br>
        <input type="submit" value="Thêm mới">
    </form>

    <!-- Bảng hiển thị danh sách sản phẩm -->
    <h2>Danh sách sản phẩm</h2>
    <table border="1">
        <tr>
            <th>ID</th>
            <th>Tên bánh</th>
            <th>Mô tả</th>
            <th>Giá</th>
            <th>Hình ảnh</th>
            <th>Thao tác</th>
        </tr>
        <?php while ($row = mysqli_fetch_assoc($resultProducts)) { ?>
            <tr>
                <td><?php echo $row['MaBanh']; ?></td>
                <td><?php echo $row['TenBanh']; ?></td>
                <td><?php echo $row['Description']; ?></td>
                <td><?php echo $row['Price']; ?></td>
                <td><img src="<?php echo $row['Image']; ?>" width="100"></td>
                <td>
                    <a href="edit_product.php?id=<?php echo $row['MaBanh']; ?>">Chỉnh sửa</a>
                    <a href="delete_product.php?id=<?php echo $row['MaBanh']; ?>">Xóa</a>
                </td>
            </tr>
        <?php } ?>
    </table>

    <h2>Danh sách đơn hàng</h2>

    <!-- Bảng hiển thị danh sách đơn hàng -->
    <table border="1">
        <tr>
            <th>Mã đơn hàng</th>
            <th>Ngày đặt hàng</th>
            <th>Ngày nhận hàng</th>
            <th>Số lượng bánh</th>
            <th>Giá trị đơn hàng</th>
            <th>Mã khách hàng</th>
            <th>Tên khách hàng</th>
            <th>Địa chỉ</th>
            <th>Số điện thoại</th>
            <th>Tên bánh</th>
            <th>Thao tác</th>
        </tr>
        <?php while ($order = mysqli_fetch_assoc($resultOrders)) { ?>
            <tr>
                <td><?php echo $order['MaDonHang']; ?></td>
                <td><?php echo $order['NgayDatHang']; ?></td>
                <td><?php echo $order['NgayNhanHang']; ?></td>
                <td><?php echo $order['SoLuongBanh']; ?></td>
                <td><?php echo $order['GiaTriDonHang']; ?></td>
                <td><?php echo $order['MaKH']; ?></td>
                <td><?php echo $order['TenKH']; ?></td>
                <td><?php echo $order['DiaChiKH']; ?></td>
                <td><?php echo $order['SoDienThoai']; ?></td>
                <td><?php echo $order['TenBanh']; ?></td>
                <td>
                    <a href="approve_order.php?id=<?php echo $order['MaDonHang']; ?>">Phê duyệt</a>
                </td>
            </tr>
        <?php } ?>
    </table>

    <h2>Danh sách tài khoản khách hàng</h2>

    <!-- Bảng hiển thị danh sách người dùng -->
    <table border="1">
        <tr>
            <!-- <th>Mã Khách Hàng</th> -->
            <th>Tên Đăng Nhập</th>
            <th>Email</th>
            <th>Họ và tên</th>
            <th>Đăng ký vào lúc</th>
            <th>Thao tác</th>
        </tr>
        <?php
        // Truy vấn cơ sở dữ liệu để lấy danh sách người dùng
        $queryUsers = "SELECT * FROM users";
        $resultUsers = mysqli_query($conn, $queryUsers);

        // Duyệt qua từng dòng dữ liệu và hiển thị trong bảng
        while ($user = mysqli_fetch_assoc($resultUsers)) {
        ?>
        <tr>
            <!-- <td><?php echo $user['id']; ?></td> -->
            <td><?php echo $user['username']; ?></td>
            <td><?php echo $user['email']; ?></td>
            <td><?php echo $user['full_name']; ?></td>
            <td><?php echo $user['created_at']; ?></td>
            <td>
            <!-- Liên kết hoặc nút cho chức năng cập nhật và xóa -->
            <a href="edit_user.php?id=<?php echo $user['id']; ?>">Chỉnh sửa</a>
            <a href="delete_user.php?id=<?php echo $user['id']; ?>">Xóa</a>
            </td>
        </tr>
        <?php } ?>
    </table>

    <?php mysqli_close($conn); ?>
</body>
</html>



        <!-- Thêm hình thức thanh toán -->
        <div class="input-group">
            <label for="payment-method">Hình thức thanh toán:</label>
            <!-- <div>
                <input type="radio" id="vnpay" name="payment_method" value="vnpay" required>
                <label for="vnpay">VNPay</label>
            </div> -->

            <div>
                <label for="momo"><input type="radio" id="momo" name="payment_method" value="momo"> MoMo</label>
            </div>
            
            <div>
            <label for="bank_transfer"><input type="radio" id="bank_transfer" name="payment_method" value="bank_transfer"> Chuyển khoản ngân hàng</label>
            </div>

            <div id="bank-transfer-info" style="display: none; margin-top: 10px;">
                <p><strong>Thông tin chuyển khoản:</strong></p>
                <p>Ngân hàng: ABC Bank</p>
                <p>Số tài khoản: 01010101</p>
                <p>Chủ tài khoản: CakesofBetty</p>
                <p>Nội dung chuyển khoản: Tên và Số điện thoại</p>
                <label for="upload-bill">Tải lên hình ảnh hóa đơn chuyển khoản:</label>
                <input type="file" id="upload-bill" name="upload_bill" accept="image/*">
            </div>

            <div>
                <label for="cod"><input type="radio" id="cod" name="payment_method" value="cod"> Thanh toán khi nhận hàng (COD)</label>
            </div>
        </div>



        <?php
include 'config.php';

session_start();

// Kết nối cơ sở dữ liệu
$conn = new mysqli($servername, $username, $password, $dbname);

// Kiểm tra kết nối
if ($conn->connect_error) {
    die("Kết nối thất bại: " . $conn->connect_error);
}

// Cập nhật trạng thái đơn hàng
if (isset($_POST['update_status'])) {
    $order_id = $_POST['order_id'];
    $new_status = $_POST['status'];

    $sql_update = "UPDATE donhang SET trangThai = ? WHERE MaDonHang = ?";
    $stmt = $conn->prepare($sql_update);
    $stmt->bind_param("si", $new_status, $order_id);

    if ($stmt->execute()) {
        echo "Cập nhật trạng thái thành công!";
    } else {
        echo "Lỗi khi cập nhật trạng thái: " . $conn->error;
    }
    $stmt->close();
}

// Truy vấn để lấy danh sách đơn hàng cùng trạng thái
$queryOrders = "SELECT donhang.MaDonHang, donhang.NgayDatHang, donhang.NgayNhanHang, 
                donhang.SoLuongBanh, donhang.GiaTriDonHang, donhang.MaKH, 
                khachhang.TenKH, khachhang.DiaChiKH, khachhang.SoDienThoai, 
                banhngot.TenBanh, donhang.trangThai
                FROM donhang 
                INNER JOIN khachhang ON donhang.MaKH = khachhang.MaKH 
                INNER JOIN banhngot ON donhang.MaBanh = banhngot.MaBanh";
$result = $conn->query($queryOrders);
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Đơn hàng</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f3f4f6;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 24px;
            font-weight: bold;
        }
/* Reset CSS */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Quicksand', sans-serif;
}

.container {
    width: 90%;
    margin: 0 auto;
}

.header {
    background-color: #f2f2f2;
    padding: 20px 0;
}

.header .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header .logo {
    font-size: 24px;
}

.admin-info {
    display: flex;
    align-items: center;
}

.content {
    padding: 20px 0;
}

.order-list {
    margin-bottom: 40px;
}

.order-table {
    width: 100%;
    border-collapse: collapse;
}

.order-table th,
.order-table td {
    border: 1px solid #ddd;
    padding: 8px;
}

.order-table th {
    position: sticky;
    top: 0;
    background-color:#c89898;
    text-align: left;
}

.order-table img {
    max-width: 100px;
}

.order-table a {
    text-decoration: none;
    color: #007bff;
}

.order-table a:hover {
    text-decoration: underline;
}

        /* CSS cho icon */
        .back-to-admin {
            display: block;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
            color: #333; /* Màu chữ */
            font-weight: bold;
            font-size: 16px;
            transition: color 0.3s ease-in-out;
        }

        .back-to-admin i {
            margin-right: 5px;
            font-size: 20px;
            transition: transform 0.3s ease-in-out;
        }

        .back-to-admin:hover i {
            transform: translateX(-3px);
        }

        .back-to-admin:hover {
            color: rgb(255, 64, 129); /* Màu khi di chuột qua */
        }
        .order-list {
            overflow: auto; /* Kích hoạt thanh cuộn khi cần thiết */
            max-height: 500px; /* Định chiều cao tối đa cho phần danh sách */
        }

        .order-table tbody {
            overflow: hidden; /* Ẩn phần vượt quá phần tử cha */
        }

        .title{
            text-decoration: none;
            color: #523020; /* Màu cho các liên kết */
            font-size: 30px;
            font-weight: bolder;
        }

        h2 {
            text-align: center;
            color: #4CAF50;
            margin-top: 0px; /* Khoảng cách giữa tiêu đề và bảng */
            margin-bottom: 20px; /* Khoảng cách giữa các tiêu đề */
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        select, button {
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .update-form {
            display: inline-block;
        }
    </style>
</head>
<body>

<h1>Quản lý Đơn hàng</h1>

<table>
    <tr>
        <th>Mã Đơn Hàng</th>
        <th>Ngày Đặt Hàng</th>
        <th>Ngày Nhận Hàng</th>
        <th>Số Lượng Bánh</th>
        <th>Giá Trị Đơn Hàng</th>
        <th>Mã Khách Hàng</th>
        <th>Tên Khách Hàng</th>
        <th>Địa Chỉ</th>
        <th>Số Điện Thoại</th>
        <th>Tên Bánh</th>
        <th>Trạng Thái</th>
        <th>Thao Tác</th>
    </tr>
    <?php
    if ($result->num_rows > 0) {
        while($row = $result->fetch_assoc()) {
            ?>
            <tr>
                <td><?= $row['MaDonHang'] ?></td>
                <td><?= $row['NgayDatHang'] ?></td>
                <td><?= $row['NgayNhanHang'] ?></td>
                <td><?= $row['SoLuongBanh'] ?></td>
                <td><?= $row['GiaTriDonHang'] ?></td>
                <td><?= $row['MaKH'] ?></td>
                <td><?= $row['TenKH'] ?></td>
                <td><?= $row['DiaChiKH'] ?></td>
                <td><?= $row['SoDienThoai'] ?></td>
                <td><?= $row['TenBanh'] ?></td>
                <td><?= $row['trangThai'] ?></td>
                <td>
                    <form method="post" action="" class="update-form">
                        <input type="hidden" name="order_id" value="<?= $row['MaDonHang'] ?>">
                        <select name="status">
                            <option value="xác nhận" <?= $row['trangThai'] == 'xác nhận' ? 'selected' : '' ?>>Xác Nhận</option>
                            <option value="đang giao" <?= $row['trangThai'] == 'đang giao' ? 'selected' : '' ?>>Đang Giao</option>
                            <option value="hoàn thành" <?= $row['trangThai'] == 'hoàn thành' ? 'selected' : '' ?>>Hoàn Thành</option>
                        </select>
                        <button type="submit" name="update_status">Cập Nhật</button>
                    </form>
                </td>
            </tr>
            <?php
        }
    } else {
        echo "<tr><td colspan='12'>Không có đơn hàng nào.</td></tr>";
    }
    ?>
</table>

<?php
$conn->close();
?>

</body>
</html>
